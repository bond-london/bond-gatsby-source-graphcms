{"version":3,"sources":["src/gatsby-node.js"],"names":["crypto","fs","path","wrapQueryExecutorWithQueue","loadSchema","readOrGenerateDefaultFragments","compileNodeQueries","buildNodeDefinitions","createSchemaCustomization","createToolkitSchemaCustomization","sourceAllNodes","sourceNodeChanges","generateImageData","getGatsbyImageResolver","createRemoteFileNode","he","fetch","pluginOptionsSchema","Joi","object","buildMarkdownNodes","boolean","description","default","downloadLocalImages","endpoint","string","required","fragmentsPath","locales","array","items","min","stages","token","typePrefix","createSourcingConfig","gatsbyApi","execute","operationName","query","variables","reporter","method","body","JSON","stringify","headers","Authorization","then","response","ok","panic","Error","statusText","json","errors","catch","error","schema","nodeInterface","getType","queryFields","getFields","possibleTypes","getPossibleTypes","singularRootFieldName","type","Object","keys","find","fieldName","pluralRootFieldName","String","name","hasLocaleField","locale","gatsbyNodeTypes","map","remoteTypeName","queries","stage","join","nodeQueryVariables","id","where","fragmentsDir","process","cwd","existsSync","mkdirSync","addSystemFieldArguments","field","includes","variation","fragments","defaultArgumentValues","documents","customFragments","concurrency","gatsbyTypePrefix","gatsbyNodeDefs","sourceNodes","pluginOptions","webhookBody","config","length","operation","data","nodeEvent","__typename","eventName","remoteId","localizations","nodeEvents","onCreateNode","node","actions","createNode","createNodeId","getCache","mimeType","fileNode","url","parentNodeId","fileName","ext","extname","localFile","e","console","fields","entries","key","value","filter","forEach","decodedMarkdown","decode","markdown","markdownNode","parent","internal","mediaType","content","contentDigest","createHash","update","digest","createTypes","generateImageSource","baseURL","width","height","format","fit","quality","src","resolveGatsbyImageData","handle","filename","options","imageDataArgs","pluginName","sourceMetadata","split","createResolvers","typeName","gatsbyImageData"],"mappings":"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","sourcesContent":["import crypto from 'crypto'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport {\r\n  wrapQueryExecutorWithQueue,\r\n  loadSchema,\r\n  readOrGenerateDefaultFragments,\r\n  compileNodeQueries,\r\n  buildNodeDefinitions,\r\n  createSchemaCustomization as createToolkitSchemaCustomization,\r\n  sourceAllNodes,\r\n  sourceNodeChanges,\r\n} from 'gatsby-graphql-source-toolkit'\r\nimport { generateImageData } from 'gatsby-plugin-image'\r\nimport { getGatsbyImageResolver } from 'gatsby-plugin-image/graphql-utils'\r\nimport { createRemoteFileNode } from 'gatsby-source-filesystem'\r\nimport he from 'he'\r\nimport fetch from 'node-fetch'\r\n\r\nexport function pluginOptionsSchema({ Joi }) {\r\n  return Joi.object({\r\n    buildMarkdownNodes: Joi.boolean()\r\n      .description(\r\n        `Build markdown nodes for all [RichText](https://graphcms.com/docs/reference/fields/rich-text) fields in your GraphCMS schema`\r\n      )\r\n      .default(false),\r\n    downloadLocalImages: Joi.boolean()\r\n      .description(\r\n        `Download and cache GraphCMS image assets in your Gatsby project`\r\n      )\r\n      .default(false),\r\n    endpoint: Joi.string()\r\n      .description(\r\n        `The endpoint URL for the GraphCMS project. This can be found in the [project settings UI](https://graphcms.com/docs/guides/concepts/apis#working-with-apis)`\r\n      )\r\n      .required(),\r\n    fragmentsPath: Joi.string()\r\n      .description(\r\n        `The local project path where generated query fragments are saved. This is relative to your current working directory. If using multiple instances of the source plugin, you **must** provide a value here to prevent type and/or fragment conflicts.`\r\n      )\r\n      .default(`graphcms-fragments`),\r\n    locales: Joi.array()\r\n      .description(\r\n        `An array of locale key strings from your GraphCMS project. You can read more about working with localisation in GraphCMS [here](https://graphcms.com/docs/guides/concepts/i18n).`\r\n      )\r\n      .items(Joi.string())\r\n      .min(1)\r\n      .default(['en']),\r\n    stages: Joi.array()\r\n      .description(\r\n        `An array of Content Stages from your GraphCMS project. You can read more about using Content Stages [here](https://graphcms.com/guides/working-with-content-stages).`\r\n      )\r\n      .items(Joi.string())\r\n      .min(1)\r\n      .default(['PUBLISHED']),\r\n    token: Joi.string().description(\r\n      `If your GraphCMS project is **not** publicly accessible, you will need to provide a [Permanent Auth Token](https://graphcms.com/docs/reference/authorization) to correctly authorize with the API. You can learn more about creating and managing API tokens [here](https://graphcms.com/docs/guides/concepts/apis#working-with-apis)`\r\n    ),\r\n    typePrefix: Joi.string()\r\n      .description(\r\n        `The string by which every generated type name is prefixed with. For example, a type of Post in GraphCMS would become GraphCMS_Post by default. If using multiple instances of the source plugin, you **must** provide a value here to prevent type conflicts`\r\n      )\r\n      .default(`GraphCMS_`),\r\n  })\r\n}\r\n\r\nconst createSourcingConfig = async (\r\n  gatsbyApi,\r\n  { endpoint, fragmentsPath, locales, stages, token, typePrefix }\r\n) => {\r\n  const execute = async ({ operationName, query, variables = {} }) => {\r\n    const { reporter } = gatsbyApi\r\n\r\n    return await fetch(endpoint, {\r\n      method: 'POST',\r\n      body: JSON.stringify({ query, variables, operationName }),\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...(token && { Authorization: `Bearer ${token}` }),\r\n      },\r\n    })\r\n      .then((response) => {\r\n        if (!response.ok) {\r\n          return reporter.panic(\r\n            `gatsby-source-graphcms: Problem building GraphCMS nodes`,\r\n            new Error(response.statusText)\r\n          )\r\n        }\r\n\r\n        return response.json()\r\n      })\r\n      .then((response) => {\r\n        if (response.errors) {\r\n          return reporter.panic(\r\n            `gatsby-source-graphcms: Problem building GraphCMS nodes`,\r\n            new Error(response.errors)\r\n          )\r\n        }\r\n\r\n        return response\r\n      })\r\n      .catch((error) => {\r\n        return reporter.panic(\r\n          `gatsby-source-graphcms: Problem building GraphCMS nodes`,\r\n          new Error(error)\r\n        )\r\n      })\r\n  }\r\n  const schema = await loadSchema(execute)\r\n\r\n  const nodeInterface = schema.getType('Node')\r\n  const query = schema.getType('Query')\r\n  const queryFields = query.getFields()\r\n  const possibleTypes = schema.getPossibleTypes(nodeInterface)\r\n\r\n  const singularRootFieldName = (type) =>\r\n    Object.keys(queryFields).find(\r\n      (fieldName) => queryFields[fieldName].type === type\r\n    )\r\n\r\n  const pluralRootFieldName = (type) =>\r\n    Object.keys(queryFields).find(\r\n      (fieldName) => String(queryFields[fieldName].type) === `[${type.name}!]!`\r\n    )\r\n\r\n  const hasLocaleField = (type) => type.getFields().locale\r\n\r\n  const gatsbyNodeTypes = possibleTypes.map((type) => ({\r\n    remoteTypeName: type.name,\r\n    queries: [\r\n      ...locales.map((locale) =>\r\n        stages.map(\r\n          (stage) => `\r\n          query LIST_${pluralRootFieldName(\r\n            type\r\n          )}_${locale}_${stage} { ${pluralRootFieldName(type)}(first: $limit, ${\r\n            hasLocaleField(type) ? `locales: [${locale}]` : ''\r\n          }, skip: $offset, stage: ${stage}) {\r\n              ..._${type.name}Id_\r\n            }\r\n          }`\r\n        )\r\n      ),\r\n      `query NODE_${singularRootFieldName(type)}{ ${singularRootFieldName(\r\n        type\r\n      )}(where: $where, ${hasLocaleField(type) ? `locales: $locales` : ''}) {\r\n        ..._${type.name}Id_\r\n        }\r\n      }\r\n      fragment _${type.name}Id_ on ${type.name} {\r\n        __typename\r\n        id\r\n        ${hasLocaleField(type) ? `locale` : ''}\r\n        stage\r\n      }`,\r\n    ].join('\\n'),\r\n    nodeQueryVariables: ({ id, locale, stage }) => ({\r\n      where: { id },\r\n      locales: [locale],\r\n      stage,\r\n    }),\r\n  }))\r\n\r\n  const fragmentsDir = `${process.cwd()}/${fragmentsPath}`\r\n\r\n  if (!fs.existsSync(fragmentsDir)) fs.mkdirSync(fragmentsDir)\r\n\r\n  const addSystemFieldArguments = (field) => {\r\n    if (['createdAt', 'publishedAt', 'updatedAt'].includes(field.name))\r\n      return { variation: `COMBINED` }\r\n  }\r\n\r\n  const fragments = await readOrGenerateDefaultFragments(fragmentsDir, {\r\n    schema,\r\n    gatsbyNodeTypes,\r\n    defaultArgumentValues: [addSystemFieldArguments],\r\n  })\r\n\r\n  const documents = compileNodeQueries({\r\n    schema,\r\n    gatsbyNodeTypes,\r\n    customFragments: fragments,\r\n  })\r\n\r\n  return {\r\n    gatsbyApi,\r\n    schema,\r\n    execute: wrapQueryExecutorWithQueue(execute, { concurrency: 10 }),\r\n    gatsbyTypePrefix: typePrefix,\r\n    gatsbyNodeDefs: buildNodeDefinitions({ gatsbyNodeTypes, documents }),\r\n  }\r\n}\r\n\r\nexport async function sourceNodes(gatsbyApi, pluginOptions) {\r\n  const { webhookBody } = gatsbyApi\r\n\r\n  const config = await createSourcingConfig(gatsbyApi, pluginOptions)\r\n\r\n  await createToolkitSchemaCustomization(config)\r\n\r\n  if (webhookBody && Object.keys(webhookBody).length) {\r\n    const { operation, data } = webhookBody\r\n\r\n    const nodeEvent = (operation, { __typename, locale, id }) => {\r\n      switch (operation) {\r\n        case 'delete':\r\n        case 'unpublish':\r\n          return {\r\n            eventName: 'DELETE',\r\n            remoteTypeName: __typename,\r\n            remoteId: { __typename, locale, id },\r\n          }\r\n        case 'create':\r\n        case 'publish':\r\n        case 'update':\r\n          return {\r\n            eventName: 'UPDATE',\r\n            remoteTypeName: __typename,\r\n            remoteId: { __typename, locale, id },\r\n          }\r\n      }\r\n    }\r\n\r\n    const { localizations = [{ locale: 'en' }] } = data\r\n\r\n    await sourceNodeChanges(config, {\r\n      nodeEvents: localizations.map(({ locale }) =>\r\n        nodeEvent(operation, { locale, ...data })\r\n      ),\r\n    })\r\n  } else {\r\n    await sourceAllNodes(config)\r\n  }\r\n}\r\n\r\nexport async function onCreateNode(\r\n  { node, actions: { createNode }, createNodeId, getCache },\r\n  {\r\n    buildMarkdownNodes = false,\r\n    downloadLocalImages = false,\r\n    typePrefix = 'GraphCMS_',\r\n  }\r\n) {\r\n  if (\r\n    downloadLocalImages &&\r\n    node.remoteTypeName === 'Asset' &&\r\n    node.mimeType.includes('image/')\r\n  ) {\r\n    try {\r\n      const fileNode = await createRemoteFileNode({\r\n        url: node.url,\r\n        parentNodeId: node.id,\r\n        createNode,\r\n        createNodeId,\r\n        getCache,\r\n        ...(node.fileName && {\r\n          name: node.fileName,\r\n          ext: path.extname(node.fileName),\r\n        }),\r\n      })\r\n\r\n      if (fileNode) node.localFile = fileNode.id\r\n    } catch (e) {\r\n      console.error('gatsby-source-graphcms:', e)\r\n    }\r\n  }\r\n\r\n  if (buildMarkdownNodes) {\r\n    const fields = Object.entries(node)\r\n      .map(([key, value]) => ({ key, value }))\r\n      .filter(\r\n        ({ value }) =>\r\n          value && value.remoteTypeName && value.remoteTypeName === 'RichText'\r\n      )\r\n\r\n    if (fields.length) {\r\n      fields.forEach((field) => {\r\n        const decodedMarkdown = he.decode(field.value.markdown)\r\n\r\n        const markdownNode = {\r\n          id: `MarkdownNode:${createNodeId(`${node.id}-${field.key}`)}`,\r\n          parent: node.id,\r\n          internal: {\r\n            type: `${typePrefix}MarkdownNode`,\r\n            mediaType: 'text/markdown',\r\n            content: decodedMarkdown,\r\n            contentDigest: crypto\r\n              .createHash(`md5`)\r\n              .update(decodedMarkdown)\r\n              .digest(`hex`),\r\n          },\r\n        }\r\n\r\n        createNode(markdownNode)\r\n\r\n        field.value.markdownNode = markdownNode.id\r\n      })\r\n    }\r\n  }\r\n}\r\n\r\nexport function createSchemaCustomization(\r\n  { actions: { createTypes } },\r\n  {\r\n    buildMarkdownNodes = false,\r\n    downloadLocalImages = false,\r\n    typePrefix = 'GraphCMS_',\r\n  }\r\n) {\r\n  if (downloadLocalImages)\r\n    createTypes(`\r\n      type ${typePrefix}Asset {\r\n        localFile: File @link\r\n      }\r\n    `)\r\n\r\n  if (buildMarkdownNodes)\r\n    createTypes(`\r\n      type ${typePrefix}MarkdownNode implements Node {\r\n        id: ID!\r\n      }\r\n      type ${typePrefix}RichText {\r\n        markdownNode: ${typePrefix}MarkdownNode @link\r\n      }\r\n    `)\r\n}\r\n\r\nconst generateImageSource = (\r\n  baseURL,\r\n  width,\r\n  height,\r\n  format,\r\n  fit = 'clip',\r\n  { quality = 100 }\r\n) => {\r\n  const src = `https://media.graphcms.com/resize=width:${width},height:${height},fit:${fit}/output=quality:${quality}/${baseURL}`\r\n\r\n  return { src, width, height, format }\r\n}\r\n\r\nconst resolveGatsbyImageData = async (\r\n  { handle: filename, height, mimeType, width },\r\n  options\r\n) => {\r\n  const imageDataArgs = {\r\n    ...options,\r\n    pluginName: `gatsby-source-graphcms`,\r\n    sourceMetadata: { format: mimeType.split('/')[1], height, width },\r\n    filename,\r\n    generateImageSource,\r\n    options,\r\n  }\r\n\r\n  return generateImageData(imageDataArgs)\r\n}\r\n\r\nexport function createResolvers(\r\n  { createResolvers },\r\n  { typePrefix = 'GraphCMS_' }\r\n) {\r\n  const typeName = `${typePrefix}Asset`\r\n\r\n  createResolvers({\r\n    [typeName]: {\r\n      gatsbyImageData: getGatsbyImageResolver(resolveGatsbyImageData, {\r\n        quality: {\r\n          type: 'Int',\r\n          description:\r\n            'The default image quality generated. This is overridden by any format-specific options.',\r\n        },\r\n      }),\r\n    },\r\n  })\r\n}\r\n"],"file":"gatsby-node.js"}